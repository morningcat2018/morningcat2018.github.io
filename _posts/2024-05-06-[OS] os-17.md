---
layout:     post
title:      æ“ä½œç³»ç»Ÿè¯¾ç¨‹2024-17
subtitle:   C æ ‡å‡†åº“è®¾è®¡ä¸å®ç°
date:       2024-05-06
author:     BY morningcat
header-img: img/201904/UNADJUSTEDNONRAW_thumb_640.jpg
catalog: true
tags:
    - OS
---

- [è§†é¢‘å›æ”¾](https://www.bilibili.com/video/BV1gZ421H7Mh)
- [è¯¾ä»¶èµ„æ–™](https://jyywiki.cn/OS/2024/lect17.md)


## å…³äº PIPE

æŸ¥çœ‹æ‰‹å†Œ 

> man 7 pipe

Broken pipeé—®é¢˜

> `python3 -c 'while True: print(1)' | head -n 1`

```
> python3 -c 'while True: print(1)' | head -n 1
1
Traceback (most recent call last):
  File "<string>", line 1, in <module>
BrokenPipeError: [Errno 32] Broken pipe
Exception ignored in: <_io.TextIOWrapper name='<stdout>' mode='w' encoding='utf-8'>
BrokenPipeError: [Errno 32] Broken pipe
```

> `(yes; echo $? > /dev/stderr) | head -n 1`

```
> (yes; echo $? > /dev/stderr) | head -n 1
y
141
```

## å…³äº _start


```c
void main(){

}

void _start(){
    main();
    // handle
    systemcall(SYS_exit, 0);
}
```

> gcc -Wall -g -ffreestanding -nostdlib -static sh.c -o sh

## glibc

libcæ˜¯Standard C libraryçš„ç®€ç§°; libcåº“æä¾›Cè¯­è¨€ä¸­æ‰€ä½¿ç”¨çš„å®ï¼Œç±»å‹å®šä¹‰ï¼Œå­—ç¬¦ä¸²æ“ä½œå‡½æ•°ï¼Œæ•°å­¦è®¡ç®—å‡½æ•°ä»¥åŠè¾“å…¥è¾“å‡ºå‡½æ•°ç­‰ã€‚
æˆ‘ä»¬åœ¨Linuxæ“ä½œç³»ç»Ÿä¸‹æ‰€è¯´çš„libcå³glibc, glibcæ˜¯ç±»Unixæ“ä½œç³»ç»Ÿä¸­ä½¿ç”¨æœ€å¹¿æ³›çš„libcåº“ï¼Œå®ƒçš„å…¨ç§°æ˜¯GNU C Libraryã€‚

glibcæ˜¯GNUå·¥å…·é“¾çš„å…³é”®ç»„ä»¶ï¼Œç”¨äºå’ŒäºŒè¿›åˆ¶å·¥å…·å’Œç¼–è¯‘å™¨ä¸€èµ·ä½¿ç”¨ï¼Œä¸ºç›®æ ‡æ¶æ„ç”Ÿæˆç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºã€‚
å½“ä»æºç è¿›è¡Œæ„å»ºæ—¶ï¼Œä¸€äº›Linuxç¨‹åºå¯èƒ½éœ€è¦é“¾æ¥åˆ°æŸä¸ªç‰¹å®šç‰ˆæœ¬çš„glibcã€‚

> ldd --version 

> /lib/x86_64-linux-gnu/libc.so.6

- https://www.gnu.org/software/libc/
- https://ftp.gnu.org/gnu/libc/

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](/png/os/libc.png)


## musl libc

musl is an implementation of the C standard library built on top of the Linux system call API

https://musl.libc.org/

> which mush-gcc

> cat (which mush-gcc)

## Freestanding ç¯å¢ƒ

- https://zh.cppreference.com/w/cpp/freestanding
- https://cplusplus.com/reference/cinttypes/



## FILE

```c
#include <stdio.h>

int main() {
    FILE *p = fopen("1.txt","r");
    printf("*p=%p\n", p);
    if(!p){
        perror("not open");
        return 1;
    }
    return 0;
}
```

## env

```c
#include <stdio.h>

extern char ** environ;

int main() {
    for(char **env=environ;*env;env++){
        printf("%s\n", *env);
    }
    return 0;
}
```

ç­‰æ•ˆäº

```c
#include <stdio.h>

int main(int argc, char *argv[], char *envp[]) {
    for(char **env=envp;*env;env++){
        printf("%s\n", *env);
    }
    return 0;
}
```

## System V Application Binary Interface

[https://jyywiki.cn/OS/manuals/sysv-abi.pdf](/pdf/sysv-abi.pdf)

ç»™libcçš„å®ç°è€…å†™çš„,å¦‚æœæƒ³è¦å®ç°è‡ªå·±çš„ libc å®ç°,åˆ™éµå®ˆè¿™ä¸ªæ ‡å‡†çš„è¯,ä»£ç çš„è¿è¡Œæ•ˆæœå°†ä¸å…¶ä»–ç³»ç»Ÿçš„è¿è¡Œæ•ˆæœä¸€è‡´.

## åŠ¨æ€å†…å­˜ç®¡ç†

åˆ©ç”¨ mmap ç³»ç»Ÿè°ƒç”¨,è‡ªå·±å®ç° malloc å’Œ free å‡½æ•°


## è„±ç¦» workload åšä¼˜åŒ–å°±æ˜¯è€æµæ°“

å»å“ªé‡Œæ‰¾ workload? å½“ç„¶æ˜¯ paper äº†

[Mimalloc: free list sharding in action (APLAS'19)](https://www.microsoft.com/en-us/research/uploads/prod/2019/06/mimalloc-tr-v1.pdf) [or](/pdf/mimalloc-tr-v1.pdf)

## Thinking, Fast and Slow by Daniel Kahneman

- Fast path (System I) æ€§èƒ½æå¥½ã€å¹¶è¡Œåº¦æé«˜ã€è¦†ç›–å¤§éƒ¨åˆ†æƒ…å†µ ; ä½†æœ‰å°æ¦‚ç‡ä¼šå¤±è´¥
- Slow path (System II)  ä¸åœ¨ä¹é‚£ä¹ˆå¿«, ä½†ä¸ä¼šå¤±è´¥

## malloc: Fast Path è®¾è®¡

- çº¿ç¨‹éƒ½äº‹å…ˆç“œåˆ†ä¸€äº› â€œé¢†åœ°â€ (thread-local allocation buffer)
- é»˜è®¤ä»è‡ªå·±çš„é¢†åœ°é‡Œåˆ†é…
- å¦‚æœè‡ªå·±çš„é¢†åœ°ä¸è¶³ï¼Œå°±ä»å…¨å±€çš„æ± å­é‡Œå€Ÿä¸€ç‚¹

```
åˆ†é…: Segregated List (Slab)
æ¯ä¸ª slab é‡Œçš„æ¯ä¸ªå¯¹è±¡éƒ½ä¸€æ ·å¤§
æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰æ¯ä¸ªå¯¹è±¡å¤§å°çš„ slab
fast path â†’ ç«‹å³åœ¨çº¿ç¨‹æœ¬åœ°åˆ†é…å®Œæˆ
slow path â†’ pgalloc()

åŠ¨æ€å†…å­˜ç®¡ç†å°å†…å­˜ï¼šSegregated List (cont'd)
åˆ†é…: Slab
é—®é¢˜è¢«ç®€åŒ–äº†
ä¸€ä¸ªå†…å­˜é¡µè¢«åˆ†é…æˆå¤§å°æ˜¯ 2^ğ‘˜çš„åˆ†é…å•å…ƒ
æ¯ä¸ªåˆ†é…å•å…ƒé‡Œå¡ä¸ªæŒ‡é’ˆï¼Œå°±æ˜¯ free list äº†
(uintptr_t)p & 0xfff å°±å¯ä»¥å¾—åˆ°å¯¹åº”çš„ slab
å¤´éƒ¨å¯ä»¥å­˜æ”¾ä¸€äº› metadataï¼Œä¾‹å¦‚è‡ªæ—‹é”
å›æ”¶ï¼šç›´æ¥å½’è¿˜åˆ° slab ä¸­
æ³¨æ„è¿™å¯èƒ½æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰çš„ slab
éœ€è¦ per-slab é” (å°å¿ƒæ•°æ®ç«äº‰)
```

